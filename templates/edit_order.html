{% extends "base.html" %}

{% block title %}Edit Order - VAPA Order System{% endblock %}

{% block content %}
<h2>Edit Order</h2>

<form method="POST" action="{{ url_for('edit_order', order_id=order.id) }}" class="form-container" id="orderForm">
    <div class="form-group">
        <label for="vendor">Vendor Name *</label>
        <input type="text" id="vendor" name="vendor" class="form-control" value="{{ order.vendor }}" required>
    </div>
    
    <h3>Order Items</h3>
    <div class="order-items-container">
        <table class="order-items-table" id="itemsTable">
            <thead>
                <tr>
                    <th style="width: 10%;">Catalog #</th>
                    <th style="width: 25%;">Description</th>
                    <th style="width: 8%;">Quantity</th>
                    <th style="width: 12%;">Unit Cost</th>
                    <th style="width: 10%;">Total</th>
                    <th style="width: 22%;">Category</th>
                    <th style="width: 8%;">Action</th>
                </tr>
            </thead>
            <tbody id="itemsBody">
                {% for item in order.items %}
                <tr class="item-row" data-item-id="{{ item.id }}">
                    <input type="hidden" name="item_id" value="{{ item.id }}">
                    <td><input type="text" name="catalog_{{ loop.index0 }}" class="form-control" value="{{ item.catalog_number or '' }}"></td>
                    <td><input type="text" name="description_{{ loop.index0 }}" class="form-control" value="{{ item.description or '' }}"></td>
                    <td><input type="number" name="quantity_{{ loop.index0 }}" class="form-control item-quantity" value="{{ item.quantity or '' }}" min="0"></td>
                    <td><input type="number" name="unit_cost_{{ loop.index0 }}" class="form-control item-unit-cost" value="{{ item.unit_cost or '' }}" step="0.01" min="0"></td>
                    <td class="item-total">${{ "{:.2f}".format(item.total_cost) }}</td>
                    <td>
                        <select name="category_{{ loop.index0 }}" class="form-control">
                            <option value="">Select...</option>
                            <option value="Books&Supplies" {% if item.category == 'Books&Supplies' %}selected{% endif %}>Books & Supplies</option>
                            <option value="Consultants" {% if item.category == 'Consultants' %}selected{% endif %}>Consultants</option>
                            <option value="Repairs" {% if item.category == 'Repairs' %}selected{% endif %}>Repairs</option>
                            <option value="SoftwareLicensing" {% if item.category == 'SoftwareLicensing' %}selected{% endif %}>Software Licensing</option>
                            <option value="ConferenceTraining" {% if item.category == 'ConferenceTraining' %}selected{% endif %}>Conference/Training</option>
                            <option value="FieldTrips" {% if item.category == 'FieldTrips' %}selected{% endif %}>Field Trips</option>
                        </select>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteItem({{ order.id }}, {{ item.id }}, this)"></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="button-group">
        <button type="button" class="btn btn-secondary" onclick="addItemRow()">+ Add Item</button>
    </div>
    
    <div class="order-summary">
        <h3>Order Summary</h3>
        <table class="summary-table">
            <tr>
                <td>Subtotal:</td>
                <td class="text-right" id="subtotal">$0.00</td>
            </tr>
            <tr>
                <td><strong>Total:</strong></td>
                <td class="text-right"><strong id="grandTotal">$0.00</strong></td>
            </tr>
        </table>
    </div>
    
    <div class="button-group">
        <button type="submit" class="btn btn-primary">Save Order</button>
        <a href="{{ url_for('view_order', order_id=order.id) }}" class="btn btn-secondary">Cancel</a>
        <form method="POST" action="{{ url_for('delete_order', order_id=order.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this entire order?');">
            <button type="submit" class="btn btn-danger">Delete Order</button>
        </form>
    </div>
</form>

<div class="back-link">
    <a href="{{ url_for('dashboard') }}">&larr; Back to Dashboard</a>
</div>

<style>
/* Responsive order items table */
/* Make the form container full width */
.form-container {
    max-width: 100% !important;
    width: 100%;
    padding: 0 1rem;
}

.container {
    max-width: 100% !important;
    width: 100%;
    padding: 0 2rem;
}

/* Override any base container constraints */
.main-content {
    max-width: 100% !important;
    width: 100%;
}
    
    .order-items-container {
    width: 100%;
    overflow-x: auto;
    margin: 1.5rem 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.order-items-table {
    width: 100%;
    min-width: 1000px;
    border-collapse: collapse;
    table-layout: fixed;
}

.order-items-table thead {
    background-color: #4472C4;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
}

.order-items-table th {
    padding: 1rem 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    border: 1px solid #3461af;
}

.order-items-table td {
    padding: 0.5rem 0.5rem;
    border: 1px solid #e9ecef;
    vertical-align: middle;
}

.order-items-table tbody tr:hover {
    background-color: #f8f9fa;
}

/* Make all inputs fill their cells */
.order-items-table input[type="text"],
.order-items-table input[type="number"],
.order-items-table select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.95rem;
    box-sizing: border-box;
}

.order-items-table input[type="text"]:focus,
.order-items-table input[type="number"]:focus,
.order-items-table select:focus {
    outline: none;
    border-color: #4472C4;
    box-shadow: 0 0 0 2px rgba(68, 114, 196, 0.1);
}

/* Make select dropdowns more visible */
.order-items-table select {
    background-color: white;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    padding-right: 2rem;
}

/* Item total column styling */
.item-total {
    font-weight: 600;
    color: #28a745;
    text-align: right;
    padding-right: 1rem !important;
}

/* Delete button in table */
.order-items-table .btn-sm {
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    width: 100%;
}

/* Responsive adjustments */
@media (max-width: 1400px) {
    .order-items-container {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
    }
    
    .order-items-table {
        min-width: 900px;
    }
}

@media (max-width: 768px) {
    .order-items-table th,
    .order-items-table td {
        padding: 0.5rem 0.3rem;
        font-size: 0.85rem;
    }
    
    .order-items-table input,
    .order-items-table select {
        font-size: 0.85rem;
        padding: 0.4rem;
    }
}
</style>

<script>
let itemCounter = {{ order.items|length }};

function addItemRow() {
    const tbody = document.getElementById('itemsBody');
    const row = document.createElement('tr');
    row.className = 'item-row';
    
    row.innerHTML = `
        <input type="hidden" name="item_id" value="">
        <td><input type="text" name="catalog_${itemCounter}" class="form-control"></td>
        <td><input type="text" name="description_${itemCounter}" class="form-control"></td>
        <td><input type="number" name="quantity_${itemCounter}" class="form-control item-quantity" min="0"></td>
        <td><input type="number" name="unit_cost_${itemCounter}" class="form-control item-unit-cost" step="0.01" min="0"></td>
        <td class="item-total">$0.00</td>
        <td>
            <select name="category_${itemCounter}" class="form-control">
                <option value="">Select...</option>
                <option value="Books&Supplies">Books & Supplies</option>
                <option value="Consultants">Consultants</option>
                <option value="Repairs">Repairs</option>
                <option value="SoftwareLicensing">Software Licensing</option>
                <option value="ConferenceTraining">Conference/Training</option>
                <option value="FieldTrips">Field Trips</option>
            </select>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">ðŸ—‘ï¸</button>
        </td>
    `;
    
    tbody.appendChild(row);
    itemCounter++;
    
    // Add event listeners to new inputs
    attachCalculationListeners(row);
    updateTotals();
}

function removeRow(button) {
    if (confirm('Remove this item?')) {
        button.closest('tr').remove();
        updateTotals();
    }
}

function deleteItem(orderId, itemId, button) {
    if (!confirm('Delete this item?')) return;
    
    fetch(`/api/order/${orderId}/item/${itemId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.closest('tr').remove();
            updateTotals();
        } else {
            alert('Error deleting item: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error deleting item');
        console.error(error);
    });
}

function updateTotals() {
    let subtotal = 0;
    
    document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitCost = parseFloat(row.querySelector('.item-unit-cost').value) || 0;
        const total = quantity * unitCost;
        
        row.querySelector('.item-total').textContent = '$' + total.toFixed(2);
        subtotal += total;
    });
    
    document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('grandTotal').textContent = '$' + subtotal.toFixed(2);
}

function attachCalculationListeners(row) {
    const quantity = row.querySelector('.item-quantity');
    const unitCost = row.querySelector('.item-unit-cost');
    
    if (quantity) quantity.addEventListener('input', updateTotals);
    if (unitCost) unitCost.addEventListener('input', updateTotals);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.item-row').forEach(attachCalculationListeners);
    updateTotals();
});
</script>
{% endblock %}
