{% extends "base.html" %}

{% block title %}All Orders - VAPA Order System{% endblock %}

{% block content %}
<h2>All Department Orders</h2>

<div class="section">
    <div class="summary-stats">
        <div class="stat-card">
            <h4>Total Orders</h4>
            <p class="stat-value">{{ total_orders }}</p>
        </div>
        <div class="stat-card">
            <h4>Total Amount</h4>
            <p class="stat-value">${{ "{:,.2f}".format(total_amount) }}</p>
        </div>
    </div>
</div>

<div class="section">
    <h3>Filter & Sort Orders</h3>
    
    <form method="GET" action="{{ url_for('admin_all_orders') }}" class="filter-form">
        <div class="filter-group">
            <div class="filter-item">
                <label for="teacher">Filter by Teacher:</label>
                <select name="teacher" id="teacher" class="form-control" onchange="this.form.submit()">
                    <option value="">All Teachers</option>
                    {% for t in teachers %}
                    <option value="{{ t.id }}" {% if teacher_filter == t.id|string %}selected{% endif %}>
                        {{ t.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-item">
                <label for="category">Filter by Category:</label>
                <select name="category" id="category" class="form-control" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>
                        {{ cat.replace('&', ' & ') }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-item">
                <label for="sort">Sort by:</label>
                <select name="sort" id="sort" class="form-control" onchange="this.form.submit()">
                    <option value="date_desc" {% if sort_by == 'date_desc' %}selected{% endif %}>Newest First</option>
                    <option value="date_asc" {% if sort_by == 'date_asc' %}selected{% endif %}>Oldest First</option>
                    <option value="teacher" {% if sort_by == 'teacher' %}selected{% endif %}>Teacher Name</option>
                    <option value="vendor" {% if sort_by == 'vendor' %}selected{% endif %}>Vendor Name</option>
                    <option value="total_desc" {% if sort_by == 'total_desc' %}selected{% endif %}>Highest Amount</option>
                    <option value="total_asc" {% if sort_by == 'total_asc' %}selected{% endif %}>Lowest Amount</option>
                </select>
            </div>
            
            <div class="filter-item">
                <a href="{{ url_for('admin_all_orders') }}" class="btn btn-secondary">Clear Filters</a>
            </div>
        </div>
    </form>
</div>

<div class="section">
    {% if orders %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Teacher</th>
                <th>Vendor</th>
                <th class="text-center">Items</th>
                <th class="text-right">Total</th>
                <th>Categories</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order_data in orders %}
            {% set order = order_data.order %}
            <tr>
                <td>{{ order.created_at.strftime('%m/%d/%Y') }}</td>
                <td><strong>{{ order.teacher.full_name }}</strong></td>
                <td>{{ order.vendor }}</td>
                <td class="text-center">{{ order_data.item_count }}</td>
                <td class="text-right">${{ "{:,.2f}".format(order_data.total) }}</td>
                <td>
                    <div class="category-tags">
                        {% for cat, amount in order_data.categories.items() %}
                        <span class="category-tag" title="${{ '{:,.2f}'.format(amount) }}">
                            {{ cat.replace('&', ' & ')[:15] }}
                        </span>
                        {% endfor %}
                    </div>
                </td>
                <td class="text-center">
                    <div class="action-buttons">
                        <a href="{{ url_for('view_order', order_id=order.id) }}" class="btn btn-secondary btn-sm" title="View Details">ðŸ‘ï¸ View</a>
                        <a href="{{ url_for('edit_order', order_id=order.id) }}" class="btn btn-primary btn-sm" title="Edit Order">âœï¸ Edit</a>
                        <form method="POST" action="{{ url_for('delete_order', order_id=order.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this order from {{ order.teacher.full_name }}?');">
                            <button type="submit" class="btn btn-danger btn-sm" title="Delete Order">ðŸ—‘ï¸</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3"><strong>TOTALS</strong></td>
                <td class="text-center"><strong>{{ orders|sum(attribute='item_count') }}</strong></td>
                <td class="text-right"><strong>${{ "{:,.2f}".format(total_amount) }}</strong></td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <div class="empty-state">
        <p>ðŸ“¦ No orders found matching your filters.</p>
        {% if teacher_filter or category_filter %}
        <a href="{{ url_for('admin_all_orders') }}" class="btn btn-primary">Clear Filters</a>
        {% else %}
        <p>Teachers haven't created any orders yet.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="back-link">
    <a href="{{ url_for('dashboard') }}">&larr; Back to Dashboard</a>
</div>

<style>
.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, #4472C4 0%, #5b8dd4 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(68, 114, 196, 0.2);
}

.stat-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.9;
}

.stat-value {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
}

.filter-form {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.filter-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-item label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    font-size: 0.9rem;
}

.category-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.category-tag {
    display: inline-block;
    background: #e7f3ff;
    color: #4472C4;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
}

.action-buttons .btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
}

.data-table tbody tr:hover {
    background-color: #f0f7ff;
}

@media (max-width: 768px) {
    .filter-group {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .data-table {
        font-size: 0.85rem;
    }
}
</style>
{% endblock %}
